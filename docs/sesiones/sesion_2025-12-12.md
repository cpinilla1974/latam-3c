# Sesión 2025-12-12: Extracción Dinámica de Indicadores

## Objetivo
Mejorar el sistema de extracción de datos de las 3 empresas cementeras peruanas implementando un enfoque dinámico que no dependa de filas hardcodeadas.

## Estado Inicial
- Scripts de extracción usaban `MAPEO_FILAS` con números de fila fijos
- Solo se extraían ~11 indicadores específicos
- El indicador 93 (Eficiencia Térmica) no se estaba extrayendo correctamente para YURA
- UNACEM 2024 se perdía al recalcular agregados

## Trabajo Realizado

### 1. Corrección de Agregados Nacionales 2024
**Problema**: No aparecían agregados nacionales para 2024 aunque las 3 empresas tenían datos.

**Causa**: El script `06_calcular_agregados.py` recalculaba `datos_empresas` desde `datos_plantas`, pero UNACEM 2024 solo existía en `datos_empresas` (no tiene desglose por planta).

**Solución**: Modificar `guardar_datos_empresas()` para eliminar solo registros específicos (empresa+año+indicador) en lugar de borrar todos los años de una empresa.

### 2. Importación de Catálogo Completo de Indicadores
**Fuente**: `/home/cpinilla/databases/comun/indicadores.db`

**Acción**: Importar todos los indicadores donde `supergrupo = 'Cemento'`

**Resultado**: 748 indicadores cargados en `metadata_indicadores`

```sql
ATTACH DATABASE '/home/cpinilla/databases/comun/indicadores.db' AS comun;
INSERT INTO metadata_indicadores (codigo_indicador, nombre_indicador, unidad, grupo, supergrupo, objeto, tipo_objeto)
SELECT codigo_indicador, nombre_indicador, unidad, grupo, supergrupo, objeto, tipo_objeto
FROM comun.indicadores WHERE supergrupo = 'Cemento';
```

### 3. Reescritura de Scripts de Extracción

Los tres scripts fueron reescritos con enfoque dinámico:

#### Enfoque Dinámico
- Lee códigos de indicadores válidos desde `metadata_indicadores`
- Detecta automáticamente la columna de códigos de indicador
- Detecta automáticamente las columnas de años
- Extrae TODOS los indicadores que coincidan con `metadata_indicadores`

#### Scripts Modificados

| Script | Empresa | Plantas | Registros | Indicadores |
|--------|---------|---------|-----------|-------------|
| `03b_extraer_pacasmayo_csi.py` | PACASMAYO | PAC, PIU, RIO | 5,755 | 165 |
| `04b_extraer_yura_csi.py` | YURA | YUR | 1,648 | 167 |
| `05b_extraer_unacem_gcca.py` | UNACEM | PIC, PIA | 2,996 | 145 |

#### Función Principal de Extracción
```python
def extraer_datos_dinamico(filepath, sheet_name, config, indicadores_validos):
    """Extrae datos de forma dinámica usando la columna de códigos de indicador."""
    df = pd.read_excel(filepath, sheet_name=sheet_name, header=None)
    columnas_años = detectar_columnas_años(df, config['fila_años'], config['primera_col_datos'])

    datos_extraidos = []
    col_codigos = config['columna_codigos']

    for fila_idx in range(len(df)):
        codigo_raw = df.iloc[fila_idx, col_codigos]
        if pd.isna(codigo_raw):
            continue
        codigo = str(codigo_raw).strip()
        if codigo not in indicadores_validos:
            continue

        for col_idx, año in columnas_años.items():
            valor = df.iloc[fila_idx, col_idx]
            if pd.notna(valor) and not isinstance(valor, str):
                datos_extraidos.append({
                    'codigo_indicador': codigo,
                    'año': int(año),
                    'valor': float(valor),
                })
    return pd.DataFrame(datos_extraidos)
```

### 4. UNACEM 2024 - Datos a Nivel Empresa
El archivo `GCCA_ProtokolV3_ UNACEM PERÚ 2024 Validado PwC.xlsm` contiene datos consolidados de empresa (no por planta).

**Configuración especial**:
```python
EMPRESA_2024_CONFIG = {
    'archivo': ARCHIVO_EMPRESA_2024,
    'hoja': 'UNACEM Perú',
    'fila_años': 6,
    'columna_codigos': 1,
    'primera_col_datos': 6,  # Columna 6 tiene los datos de 2024
    'año_maximo': 2024
}
```

**Resultado**: 127 registros insertados directamente en `datos_empresas`

## Resultado Final

### Base de Datos
| Tabla | Registros | Indicadores Únicos |
|-------|-----------|-------------------|
| datos_plantas | 10,534 | 218 |
| datos_empresas | 5,573 | - |
| agregados_nacionales | 78 | 11 |

### Años con Agregados Nacionales
2010, 2014, 2019, 2020, 2021, 2024

### Orden de Ejecución
```bash
python scripts/03b_extraer_pacasmayo_csi.py
python scripts/04b_extraer_yura_csi.py
python scripts/05b_extraer_unacem_gcca.py
python scripts/06_calcular_agregados.py
```

## Archivos Modificados
- `data_peru/scripts/03b_extraer_pacasmayo_csi.py` - Reescrito con extracción dinámica
- `data_peru/scripts/04b_extraer_yura_csi.py` - Reescrito con extracción dinámica
- `data_peru/scripts/05b_extraer_unacem_gcca.py` - Reescrito con extracción dinámica
- `data_peru/scripts/06_calcular_agregados.py` - Modificado para preservar datos empresa
- `data_peru/FUENTES_DATOS.md` - Actualizado con nueva documentación

## Próximos Pasos
- Verificar visualización de todos los indicadores en la app Streamlit
- Evaluar qué indicadores adicionales mostrar en dashboards
- Documentar indicadores clave para reporting GCCA/CSI