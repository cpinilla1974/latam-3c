# Sesión 2025-12-15: Fórmulas de Agregación Nacional FICEM

## Objetivo
Corregir e implementar las fórmulas de agregación nacional según el protocolo oficial FICEM (Anexo V1.4) para el cálculo de indicadores de emisiones brutas y netas.

## Estado Inicial
- Script `calcular_agregados_nacionales.py` calculaba indicadores pero las fórmulas de brutas/netas no seguían la estructura oficial
- Las fórmulas se expresaban como cálculos directos sobre campos base en lugar de suma de componentes
- Excel de referencia (`reporte_rp_2024.xlsx`) usaba denominadores incorrectos para algunos indicadores

## Trabajo Realizado

### 1. Corrección de Fórmulas Brutas/Netas

**Problema**: Las fórmulas de emisiones brutas y netas estaban definidas como cálculos directos sobre campos base, pero según FICEM deben ser suma de componentes pre-calculados.

**Solución**: Actualizar `FORMULAS_AGREGACION.md` y el script para expresar brutas/netas como:

| Denominador | Bruta | Neta |
|-------------|-------|------|
| Clínker [8] | 60 = 60a + 1010 + 1008 + 1009 | 73 = 60a + 1010 + 1008 |
| Cementitious [21a] | 62 = 62a + 1021 + 1022 + 1023 | 74 = 62a + 1021 + 1022 |
| Cemento [20] | 1044 = 1001 + 1002 + 1003 + 1004 | 1045 = 1001 + 1002 + 1003 |
| Cem. equivalente | 63 = 63a + 1416 + 1410 + 1411 | 75 = 63a + 1416 + 1410 |

**Componentes**:
- Descarbonatación (60a, 62a, 1001, 63a)
- Fuera de horno (1010, 1021, 1002, 1416)
- Fósiles convencionales (1008, 1022, 1003, 1410)
- Fósiles alternativos (1009, 1023, 1004, 1411) - Solo en brutas

### 2. Validación contra Excel de Referencia

Se compararon valores calculados vs Excel `reporte_rp_2024.xlsx` para 2024:

**Indicadores Clínker** - Coincidencia perfecta:
| Indicador | Calculado | Excel | Diferencia |
|-----------|-----------|-------|------------|
| 60a (Descarb.) | 510.2034 | 510.2034 | 0.0000 |
| 1008 (Fósiles conv.) | 266.8389 | 266.8389 | 0.0000 |
| 1010 (Fuera horno) | 1.7730 | 1.7730 | 0.0000 |
| 1009 (Fósiles alt.) | 2.9192 | 2.9192 | 0.0000 |
| 60 (Bruta) | 781.7346 | 781.7346 | 0.0000 |
| 73 (Neta) | 778.8154 | 778.8154 | 0.0000 |

**Indicadores Cementitious** - Coincidencia casi perfecta:
| Indicador | Calculado | Excel | Diferencia |
|-----------|-----------|-------|------------|
| 62a (Descarb.) | 382.9371 | 382.9371 | 0.0000 |
| 1022 (Fósiles conv.) | 200.2780 | 200.2780 | 0.0000 |
| 1021 (Fuera horno) | 1.3308 | 1.3308 | 0.0000 |
| 74 (Neta) | 584.5460 | 584.5460 | 0.0000 |

### 3. Discrepancia Identificada en 1023

Se encontró una pequeña diferencia en el indicador 1023 (Fósiles alternativos cementitious):
- Calculado: 2.1910 kgCO₂/t cementitious
- Excel: 2.3106 kgCO₂/t cementitious
- Diferencia: -0.1196

**Análisis**: La diferencia proviene de inconsistencia interna en el Excel de referencia:
- Campo 41 total en Excel: 25,549.28 t CO₂
- Campo 21a total en Excel: 11,660,949.54 t cementitious
- Cálculo correcto: (25,549.28 / 11,660,949.54) × 1000 = 2.1910

El valor 2.3106 del Excel requeriría un campo 41 de 26,943.79 t CO₂, lo cual no coincide con los datos base del mismo Excel. **Nuestro cálculo es correcto**.

### 4. Correcciones al Excel de Referencia

El usuario corrigió el Excel de referencia:
- Cambió denominador de cementitious de [20] a [21a]
- Removió generación on-site (1088/1020) de los cálculos de brutas/netas

### 5. Actualización de App Streamlit

Se añadió nueva página "Indicadores FICEM" a `app_visualizacion.py` con:
- Metadatos completos de todos los indicadores FICEM
- Filtro por grupo de indicadores
- Tabla de valores por año
- Gráficos de evolución temporal
- Descarga de datos en CSV

## Archivos Modificados

- `data_peru/docs/FORMULAS_AGREGACION.md` - Fórmulas corregidas (v1.2)
- `data_peru/scripts/calcular_agregados_nacionales.py` - Cálculo por suma de componentes
- `data_peru/app_visualizacion.py` - Nueva página de indicadores FICEM

## Resultado Final

Script ejecutado exitosamente con 687 registros en `agregados_nacionales`.

Validación 2024:
- Clínker: 100% coincidencia
- Cementitious: 99.98% coincidencia (diferencia en 1023 es error del Excel)
- Cemento: Pendiente validación detallada
- Cem. equivalente: Pendiente validación detallada

## Próximos Pasos
- Validar indicadores de cemento y cemento equivalente
- Completar datos de campo 41 para plantas faltantes (Atocongo, Condorcocha, Piura, Rioja)
- Extender validación a años históricos
