# Sesión de Trabajo - 2025-12-07

## Fecha
2025-12-07

## Objetivo de la sesión
Definir arquitectura definitiva del sistema basada en funcionalidades por grupo de usuarios.

## Estado inicial
- Repos creados (4c-ficem-core, 4c-peru, latam-3c)
- Arquitectura anterior asumía ficem-core solo como backend
- Faltaba claridad sobre roles de usuarios y necesidades por grupo
- TDR de Perú revisado pero no analizado en detalle

## Trabajo realizado

### 1. Revisión del TDR FICEM-ASOCEM-PRODUCE

Documento: `docs/admin/TDR_FICEM_ASOCEM_Proyecto_MRV_Peru_3.pdf`

**3 componentes identificados:**
- Ítem 1: Protocolo PRODUCE (captura, cálculos, análisis)
- Ítem 2: Sistema MRV HR Perú (Dic 2025 + Jun 2026)
- Ítem 3: Calculadora 4C Perú (Abr 2026)

**Hallazgo clave:** PRODUCE requiere datos/protocolos propios de Perú (no solo los de FICEM).

### 2. Análisis de funcionalidades por grupo de usuarios

Creado documento: `docs/1-tecnica/02-funcionalidades-por-usuario.md`

**Grupos identificados:**
- FICEM (equipo regional): Carga, validación, cálculos, gestión
- País (ej: Perú): Dashboard, reportes, TDR local, stakeholders propios
- Empresas: Acceso a sus datos, descarga Excel, benchmarking
- IA/Analítica: Servicio transversal (knowledge-api)

**Roles dentro de cada grupo:**
- FICEM: Operador, Administrador, Analista
- País: Coordinador gremio, Funcionario gobierno, Analista, Observador
- Empresas: Editor, Supervisor, Observador

### 3. Decisión de arquitectura

**Discusión sobre opciones:**
1. Backend por app (distribuido) - Más complejo, más puntos de fallo
2. Backend centralizado - Menos código, más simple para un solo desarrollador

**Decisión final: Backend Centralizado + Frontends por App**

| Repo | Tipo | Tecnología | Estado |
|------|------|------------|--------|
| 4c-ficem-core | Backend + Frontend operador | FastAPI + PostgreSQL + Streamlit | Activo |
| 4c-peru | Frontend país | Next.js | Activo |
| knowledge-api | Servicio IA | FastAPI + Vector DB | En espera |
| latam-3c | Documentación | Markdown | Mantenimiento |

**Justificación:**
1. Un solo desarrollador → menos repos es mejor
2. knowledge-api separado porque no está contratado aún (puede venderse independiente)
3. Next.js para frontends país por mejor manejo de usuarios/sesiones vs Streamlit

## Decisiones tomadas

1. **Backend centralizado en ficem-core**
   - FastAPI para APIs REST
   - PostgreSQL con esquemas por país
   - Streamlit solo para operador FICEM
   - Usuarios/sesiones centralizados

2. **Frontends país en Next.js**
   - Mejor control de UI que Streamlit
   - Manejo granular de usuarios y sesiones
   - Solo consumen APIs de ficem-core

3. **knowledge-api separado**
   - No está contratado aún
   - Debe poder crecer/venderse independiente
   - Se integra cuando se contrate

4. **Datos de países en BD central**
   - Esquemas separados por país en PostgreSQL
   - No requiere BD local por país

## Próximos pasos identificados

1. Actualizar CLAUDE.md de los repos con nueva arquitectura
2. Reestructurar ficem-core para FastAPI + PostgreSQL
3. Iniciar 4c-peru con Next.js
4. Definir modelo de datos para esquemas por país

---

### 4. Limpieza de Obsidian

Se eliminaron todos los archivos y configuraciones de Obsidian del proyecto:

**Archivos eliminados:**
- `.obsidian/` (configuración raíz)
- `docs/.obsidian/` (configuración docs)
- `tools/obsidian/` (~300 MB de binarios)
- `obsidian.sh` (script de lanzamiento)
- `docs/Sin título.canvas` (lienzo vacío)

**Archivos actualizados:**
- `.gitignore` (removidas reglas de Obsidian)
- `tools/README.md` (removida sección de Obsidian)

**Commit:** `e1ed614` - Remove Obsidian configuration and files

**Nota:** La documentación markdown es estándar y no contenía sintaxis específica de Obsidian.

---

### 5. Limpieza del repositorio Git

El repositorio tenía ~13GB de archivos grandes en el historial (venvs, vector_stores, modelos pickle).

**Solución aplicada:**
- Eliminado repositorio remoto en GitHub
- Reinicializado git local con historial limpio
- Push a nuevo repositorio

**Archivos excluidos vía .gitignore:**
- `**/venv*/` - Entornos virtuales en cualquier subdirectorio
- `**/vector_store/` - Bases de datos vectoriales
- `**/chroma_db/` - ChromaDB
- `*.pkl`, `*.joblib` - Modelos ML

---

### 6. Decisión de autenticación

**JWT centralizado en ficem-core:**
- ficem-core emite y valida tokens
- Frontends solo consumen el token
- Sin dependencias externas (Auth0, etc.)

**Contenido del JWT:** user_id, email, rol, grupo, pais_code, empresa_id

---

### 7. Flujo de datos actualizado

**Cambio importante:** Las empresas ahora cargan Excel directamente vía app país, no por email a FICEM.

**Nuevo flujo:**
1. Empresa login en 4c-peru
2. Descarga template Excel
3. Completa offline
4. Sube Excel a 4c-peru → ficem-core valida
5. Empresa confirma envío
6. Coordinador país revisa y aprueba/rechaza
7. FICEM ejecuta cálculos
8. Empresa ve resultados en 4c-peru

**Estados del envío:** borrador → enviado → en_revision → validado/rechazado → procesado → publicado

**Documentación creada:**
- `docs/1-tecnica/03-flujo-datos.md` (nuevo)
- `docs/4-historico/v1/06-flujo-proceso_HASTA_2025-12-07.md` (archivado)

---

### 8. Actualización de funcionalidades

Ajustadas funcionalidades según nuevo flujo:

**FICEM:** Ya no carga Excel, solo revisa envíos validados por países y ejecuta cálculos

**País:** Agregado "Revisar envíos de empresas (aprobar/rechazar)"

**Empresas:** Agregado "Cargar Excel", "Ver estado del envío", "Corregir y reenviar"

---

### 9. Redefinición de arquitectura (ACTUALIZACIÓN FINAL)

**Decisión crítica:** FICEM necesita su propio frontend completo, no solo operador.

**Nueva arquitectura con 2 repositorios:**

| Repo | Propósito | Tecnología |
|------|-----------|------------|
| **4c-ficem-core** | Backend API REST | FastAPI + PostgreSQL |
| **4c-ficem-web** | Frontend FICEM (nuevo) | Next.js |
| **4c-peru** | Frontend país | Next.js |
| **knowledge-api** | Servicio IA | FastAPI + Vector DB |

**Cambio fundamental:** Eliminado Streamlit completamente.

**Razón:** FICEM necesita:
1. Sección pública (landing, blog, dashboard regional)
2. Sección operador (admin completo)
3. Exploración de datos (ficem_bd)
4. Herramientas IA (knowledge-api)
5. Gestión de factores de emisión
6. Descarga masiva de datos

**Estado final de 4c-ficem-core:**
- ✅ Limpiado: Streamlit eliminado, IA eliminado, código obsoleto eliminado
- ✅ Estructura creada: `api/`, `calculos/`, `excel/`, `tests/`
- ✅ Requirements actualizado: Solo FastAPI + PostgreSQL + testing
- ✅ Documentación completa en `docs/`:
  - `ARQUITECTURA_ECOSISTEMA.md` - Visión completa del ecosistema
  - `PLAN_IMPLEMENTACION.md` - 12 fases de implementación backend
  - `FRONTEND_PAGES.md` - Especificación páginas (público + operador)

---

### 10. Plan de implementación backend

**12 Fases definidas:**

1. **FASE 1**: Base de datos (modelos: Usuario, Planta, Envío, Resultado, FactorEmision, BlogPost)
2. **FASE 2**: Autenticación JWT
3. **FASE 3**: Templates Excel
4. **FASE 4**: Carga y validación Excel
5. **FASE 5**: Motor cálculos A1-A3
6. **FASE 6**: Revisión y aprobación
7. **FASE 7**: Resultados y benchmarking
8. **FASE 8**: APIs administración (CRUD usuarios, empresas, factores)
9. **FASE 9**: APIs exploración de datos
10. **FASE 10**: APIs públicas (stats, blog)
11. **FASE 11**: Integración knowledge-api
12. **FASE 12**: Testing

**Próximo paso inmediato:** FASE 1 - Expandir modelos de base de datos

---

### 11. Frontend FICEM (4c-ficem-web)

**Páginas identificadas:**

**Sección Pública (7 páginas):**
- Home (landing)
- About
- Dashboard regional (anónimo)
- Países
- Blog (listado)
- Blog Post (detalle)
- Documentación

**Sección Operador FICEM (12 páginas):**
- Dashboard operador
- Revisión de envíos
- Gestión usuarios
- Gestión empresas
- Gestión plantas
- Factores de emisión
- Bandas GCCA
- Explorador de datos
- Descarga masiva
- Herramientas IA
- Benchmarking regional
- Gestión blog

**Stack recomendado:** Next.js 14+ (App Router) + TypeScript + TailwindCSS + shadcn/ui

---

## Documentación creada/actualizada

| Archivo | Acción | Ubicación |
|---------|--------|-----------|
| `ARQUITECTURA_ECOSISTEMA.md` | Creado | 4c-ficem-core/docs/ |
| `PLAN_IMPLEMENTACION.md` | Creado | 4c-ficem-core/docs/ |
| `FRONTEND_PAGES.md` | Creado | 4c-ficem-core/docs/ |
| `CLAUDE.md` | Actualizado | 4c-ficem-core/ |
| `README.md` | Actualizado | 4c-ficem-core/ |
| `.env.example` | Creado | 4c-ficem-core/ |
| `requirements.txt` | Limpiado | 4c-ficem-core/ |

---

## Estado de implementación

### 4c-ficem-core (Backend)
- ✅ Código obsoleto eliminado (Streamlit, IA, scripts viejos)
- ✅ Estructura de directorios creada
- ✅ Requirements limpio (solo FastAPI + PostgreSQL)
- ✅ Documentación completa
- ⏭️ **Siguiente:** FASE 1 - Expandir modelos BD

### 4c-ficem-web (Frontend FICEM)
- ⏭️ Repositorio por crear
- ⏭️ Especificación completa en FRONTEND_PAGES.md
- ⏭️ Se creará después de tener backend funcional (FASE 1-7)

### 4c-peru (Frontend País)
- ✅ Repositorio creado
- ⏭️ Implementación pendiente
- ⏭️ Se iniciará en paralelo con backend FASE 3-4

---

## Próximos pasos

**Inmediato:**
1. Implementar FASE 1 en 4c-ficem-core (modelos BD)
2. Configurar Alembic para migraciones
3. Implementar FASE 2 (autenticación JWT)

**Corto plazo:**
1. FASE 3-7: Core del backend (templates, upload, cálculos, resultados)
2. Crear repositorio 4c-ficem-web
3. Implementar páginas públicas de FICEM

**Mediano plazo:**
1. FASE 8-10: Admin APIs + exploración + APIs públicas
2. Implementar páginas operador FICEM
3. Iniciar 4c-peru

**Largo plazo:**
1. FASE 11: Integración knowledge-api
2. FASE 12: Testing completo
3. Deploy a producción

---

*Fin de sesión 2025-12-07*

*Decisiones críticas:*
- ✅ Arquitectura 2 repos: 4c-ficem-core (backend) + 4c-ficem-web (frontend FICEM)
- ✅ Streamlit eliminado completamente
- ✅ FICEM tendrá sección pública + operador
- ✅ Backend sirve a todos los frontends
- ✅ Plan de 12 fases documentado

*Estado: 4c-ficem-core limpio y listo para FASE 1*
