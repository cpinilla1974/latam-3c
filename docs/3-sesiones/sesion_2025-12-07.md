# Sesión de Trabajo - 2025-12-07

## Fecha
2025-12-07

## Objetivo de la sesión
Definir arquitectura definitiva del sistema basada en funcionalidades por grupo de usuarios.

## Estado inicial
- Repos creados (4c-ficem-core, 4c-peru, latam-3c)
- Arquitectura anterior asumía ficem-core solo como backend
- Faltaba claridad sobre roles de usuarios y necesidades por grupo
- TDR de Perú revisado pero no analizado en detalle

## Trabajo realizado

### 1. Revisión del TDR FICEM-ASOCEM-PRODUCE

Documento: `docs/admin/TDR_FICEM_ASOCEM_Proyecto_MRV_Peru_3.pdf`

**3 componentes identificados:**
- Ítem 1: Protocolo PRODUCE (captura, cálculos, análisis)
- Ítem 2: Sistema MRV HR Perú (Dic 2025 + Jun 2026)
- Ítem 3: Calculadora 4C Perú (Abr 2026)

**Hallazgo clave:** PRODUCE requiere datos/protocolos propios de Perú (no solo los de FICEM).

### 2. Análisis de funcionalidades por grupo de usuarios

Creado documento: `docs/1-tecnica/02-funcionalidades-por-usuario.md`

**Grupos identificados:**
- FICEM (equipo regional): Carga, validación, cálculos, gestión
- País (ej: Perú): Dashboard, reportes, TDR local, stakeholders propios
- Empresas: Acceso a sus datos, descarga Excel, benchmarking
- IA/Analítica: Servicio transversal (knowledge-api)

**Roles dentro de cada grupo:**
- FICEM: Operador, Administrador, Analista
- País: Coordinador gremio, Funcionario gobierno, Analista, Observador
- Empresas: Editor, Supervisor, Observador

### 3. Decisión de arquitectura

**Discusión sobre opciones:**
1. Backend por app (distribuido) - Más complejo, más puntos de fallo
2. Backend centralizado - Menos código, más simple para un solo desarrollador

**Decisión final: Backend Centralizado + Frontends por App**

| Repo | Tipo | Tecnología | Estado |
|------|------|------------|--------|
| 4c-ficem-core | Backend + Frontend operador | FastAPI + PostgreSQL + Streamlit | Activo |
| 4c-peru | Frontend país | Next.js | Activo |
| knowledge-api | Servicio IA | FastAPI + Vector DB | En espera |
| latam-3c | Documentación | Markdown | Mantenimiento |

**Justificación:**
1. Un solo desarrollador → menos repos es mejor
2. knowledge-api separado porque no está contratado aún (puede venderse independiente)
3. Next.js para frontends país por mejor manejo de usuarios/sesiones vs Streamlit

## Decisiones tomadas

1. **Backend centralizado en ficem-core**
   - FastAPI para APIs REST
   - PostgreSQL con esquemas por país
   - Streamlit solo para operador FICEM
   - Usuarios/sesiones centralizados

2. **Frontends país en Next.js**
   - Mejor control de UI que Streamlit
   - Manejo granular de usuarios y sesiones
   - Solo consumen APIs de ficem-core

3. **knowledge-api separado**
   - No está contratado aún
   - Debe poder crecer/venderse independiente
   - Se integra cuando se contrate

4. **Datos de países en BD central**
   - Esquemas separados por país en PostgreSQL
   - No requiere BD local por país

## Próximos pasos identificados

1. Actualizar CLAUDE.md de los repos con nueva arquitectura
2. Reestructurar ficem-core para FastAPI + PostgreSQL
3. Iniciar 4c-peru con Next.js
4. Definir modelo de datos para esquemas por país

---

### 4. Limpieza de Obsidian

Se eliminaron todos los archivos y configuraciones de Obsidian del proyecto:

**Archivos eliminados:**
- `.obsidian/` (configuración raíz)
- `docs/.obsidian/` (configuración docs)
- `tools/obsidian/` (~300 MB de binarios)
- `obsidian.sh` (script de lanzamiento)
- `docs/Sin título.canvas` (lienzo vacío)

**Archivos actualizados:**
- `.gitignore` (removidas reglas de Obsidian)
- `tools/README.md` (removida sección de Obsidian)

**Commit:** `e1ed614` - Remove Obsidian configuration and files

**Nota:** La documentación markdown es estándar y no contenía sintaxis específica de Obsidian.

---

### 5. Limpieza del repositorio Git

El repositorio tenía ~13GB de archivos grandes en el historial (venvs, vector_stores, modelos pickle).

**Solución aplicada:**
- Eliminado repositorio remoto en GitHub
- Reinicializado git local con historial limpio
- Push a nuevo repositorio

**Archivos excluidos vía .gitignore:**
- `**/venv*/` - Entornos virtuales en cualquier subdirectorio
- `**/vector_store/` - Bases de datos vectoriales
- `**/chroma_db/` - ChromaDB
- `*.pkl`, `*.joblib` - Modelos ML

---

### 6. Decisión de autenticación

**JWT centralizado en ficem-core:**
- ficem-core emite y valida tokens
- Frontends solo consumen el token
- Sin dependencias externas (Auth0, etc.)

**Contenido del JWT:** user_id, email, rol, grupo, pais_code, empresa_id

---

### 7. Flujo de datos actualizado

**Cambio importante:** Las empresas ahora cargan Excel directamente vía app país, no por email a FICEM.

**Nuevo flujo:**
1. Empresa login en 4c-peru
2. Descarga template Excel
3. Completa offline
4. Sube Excel a 4c-peru → ficem-core valida
5. Empresa confirma envío
6. Coordinador país revisa y aprueba/rechaza
7. FICEM ejecuta cálculos
8. Empresa ve resultados en 4c-peru

**Estados del envío:** borrador → enviado → en_revision → validado/rechazado → procesado → publicado

**Documentación creada:**
- `docs/1-tecnica/03-flujo-datos.md` (nuevo)
- `docs/4-historico/v1/06-flujo-proceso_HASTA_2025-12-07.md` (archivado)

---

### 8. Actualización de funcionalidades

Ajustadas funcionalidades según nuevo flujo:

**FICEM:** Ya no carga Excel, solo revisa envíos validados por países y ejecuta cálculos

**País:** Agregado "Revisar envíos de empresas (aprobar/rechazar)"

**Empresas:** Agregado "Cargar Excel", "Ver estado del envío", "Corregir y reenviar"

---

## Documentación creada/actualizada

| Archivo | Acción |
|---------|--------|
| `docs/1-tecnica/02-funcionalidades-por-usuario.md` | Creado y actualizado |
| `docs/1-tecnica/03-flujo-datos.md` | Creado |
| `docs/4-historico/v1/06-flujo-proceso_HASTA_2025-12-07.md` | Archivado |
| `.gitignore` | Actualizado con patrones para venv y vector_store |

---

## Próximos pasos

1. Ir a `4c-ficem-core` e implementar:
   - FastAPI con endpoints de auth, uploads, cálculos
   - PostgreSQL con esquemas por país
   - JWT
   - Streamlit para operador

2. Ir a `4c-peru` e implementar:
   - Next.js base
   - Consumo de APIs de ficem-core
   - UI para empresas y coordinadores

3. Avanzar `knowledge-api` en paralelo:
   - Aunque no está contratado, debe ir creciendo
   - Objetivo: demostrar valor para venderlo funcionando
   - POC ya existe, continuar desarrollo incremental

---

*Fin de sesión 2025-12-07*
*Decisiones: Arquitectura, autenticación JWT, flujo de datos con carga por empresa*
*Estado: Documentación completa, listo para implementación en repos de código*
