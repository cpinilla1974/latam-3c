"""
Chat de Benchmarking con IA
Piloto IA - FICEM BD
Consultas SOLO a base de datos SQL
"""

import streamlit as st
import sys
from pathlib import Path
import pandas as pd
import re

# Agregar path para imports
sys.path.insert(0, str(Path.cwd()))

from ai_modules.rag.sql_tool import SQLTool

def app():
    st.title("üí¨ Chat de Benchmarking")
    st.markdown("### Consultas a Base de Datos PostgreSQL")

    # Inicializar SQL tool √∫nicamente
    @st.cache_resource
    def get_sql_tool():
        return SQLTool()

    # Inicializar historial de chat
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # Inicializar SQL tool
    try:
        sql_tool = get_sql_tool()
        st.success(f"‚úÖ Sistema de consultas SQL listo - Base de datos PostgreSQL conectada")
    except Exception as e:
        st.error(f"‚ùå Error conectando a base de datos: {e}")
        st.stop()

    st.divider()

    # Sidebar con informacion
    with st.sidebar:
        st.header("üìä Base de Datos")

        st.markdown("""
        **Tablas disponibles:**
        - `huella_concretos` - Datos de huella de carbono
        - `cementos` - Datos de cementos
        - `plantas_latam` - Plantas de cemento
        - `tb_cubo` - Cubo multidimensional
        - `indicadores` - Cat√°logo de indicadores
        - `entidades_m49` - Pa√≠ses y regiones
        """)

        st.divider()

        st.header("üí° Preguntas Ejemplo")

        preguntas_ejemplo = [
            "Cual es la huella promedio de MZMA en 2024?",
            "Cuales son los productos con mayor huella de carbono?",
            "Que compa√±ias tienen datos en la base?",
            "Muestra el top 5 de productos por huella",
            "Cuantos remitos hay en total?",
            "Cual es la resistencia promedio por compa√±ia?"
        ]

        for pregunta in preguntas_ejemplo:
            if st.button(pregunta, key=f"ej_{pregunta[:20]}", use_container_width=True):
                st.session_state.messages.append({"role": "user", "content": pregunta})
                st.rerun()

        st.divider()

        if st.button("üóëÔ∏è Limpiar Chat", use_container_width=True):
            st.session_state.messages = []
            st.rerun()

    # Mostrar historial de mensajes
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

            # Mostrar datos SQL si existen
            if "sql_data" in message and message["sql_data"]:
                with st.expander(f"üìä Datos consultados ({len(message['sql_data'])} registros)"):
                    df = pd.DataFrame(message["sql_data"])
                    st.dataframe(df, use_container_width=True)

    # Procesar pregunta pendiente (de botones de ejemplo)
    if st.session_state.messages and st.session_state.messages[-1]["role"] == "user":
        # Hay una pregunta del usuario sin responder
        prompt = st.session_state.messages[-1]["content"]

        with st.chat_message("assistant"):
            with st.spinner("Consultando base de datos..."):
                try:
                    # Analizar pregunta y ejecutar SQL
                    respuesta = ""
                    sql_data = None

                    prompt_lower = prompt.lower()

                    # Detectar tipo de consulta
                    if "mzma" in prompt_lower or "cemex" in prompt_lower or "mel√≥n" in prompt_lower or "melon" in prompt_lower:
                        # Consulta de compa√±√≠a espec√≠fica
                        if "mzma" in prompt_lower:
                            compania = "mzma"
                        elif "cemex" in prompt_lower:
                            compania = "CEMEX"
                        else:
                            compania = "mel√≥n_main_old"

                        # Detectar a√±o
                        year_match = re.search(r'\b(202[0-9])\b', prompt)
                        a√±o = int(year_match.group(1)) if year_match else None

                        result = sql_tool.get_huella_promedio_compania(compania, a√±o)

                        if result["success"] and result["rows"]:
                            data = result["rows"][0]
                            sql_data = result["rows"]

                            num_remitos = data.get('num_remitos', 0) or 0
                            huella = data.get('huella_promedio') or 0
                            resistencia = data.get('resistencia_promedio') or 0
                            volumen = data.get('volumen_total') or 0

                            respuesta = f"""
**Datos de {compania.upper()} {f'en {a√±o}' if a√±o else '(todos los a√±os)'}:**

- **N√∫mero de remitos:** {num_remitos:,}
- **Huella promedio:** {huella:.2f} kg CO‚ÇÇ/m¬≥
- **Resistencia promedio:** {resistencia:.1f} MPa
- **Volumen total:** {volumen:,.0f} m¬≥
"""
                        else:
                            respuesta = f"‚ùå No se encontraron datos para {compania} {f'en {a√±o}' if a√±o else ''}"

                    elif "top" in prompt_lower or "mayor" in prompt_lower or "productos" in prompt_lower:
                        # Top productos
                        result = sql_tool.get_top_productos_huella(limit=5)

                        if result["success"] and result["rows"]:
                            sql_data = result["rows"]
                            respuesta = "**Top 5 productos con mayor huella de carbono:**\n\n"
                            for i, row in enumerate(result["rows"], 1):
                                respuesta += f"{i}. **{row['compania'].upper()}** - {row['resistencia']} MPa: {row['huella_promedio']:.2f} kg CO‚ÇÇ/m¬≥ (Vol: {row['volumen_total']:,.0f} m¬≥)\n"
                        else:
                            respuesta = "‚ùå No se pudieron obtener los datos"

                    elif "compa√±" in prompt_lower or "empresa" in prompt_lower:
                        # Listar compa√±√≠as
                        query = "SELECT DISTINCT origen FROM huella_concretos WHERE origen IS NOT NULL ORDER BY origen"
                        result = sql_tool.execute_query(query)

                        if result["success"] and result["rows"]:
                            sql_data = result["rows"]
                            respuesta = f"**Compa√±√≠as con datos en la base ({len(result['rows'])}):**\n\n"
                            for row in result["rows"]:
                                respuesta += f"- {row['origen'].upper()}\n"
                        else:
                            respuesta = "‚ùå No se pudieron obtener las compa√±√≠as"

                    elif "total" in prompt_lower and "remito" in prompt_lower:
                        # Total de remitos
                        query = "SELECT SUM(num_remitos) as total FROM huella_concretos"
                        result = sql_tool.execute_query(query)

                        if result["success"] and result["rows"]:
                            total = result["rows"][0]['total'] or 0
                            sql_data = result["rows"]
                            respuesta = f"**Total de remitos en la base de datos:** {total:,}"
                        else:
                            respuesta = "‚ùå No se pudo obtener el total"

                    elif "resistencia" in prompt_lower and "compa√±" in prompt_lower:
                        # Resistencia promedio por compa√±√≠a
                        query = """
                        SELECT origen as compania, AVG("REST") as resistencia_promedio
                        FROM huella_concretos
                        WHERE "REST" IS NOT NULL
                        GROUP BY origen
                        ORDER BY resistencia_promedio DESC
                        """
                        result = sql_tool.execute_query(query)

                        if result["success"] and result["rows"]:
                            sql_data = result["rows"]
                            respuesta = "**Resistencia promedio por compa√±√≠a:**\n\n"
                            for row in result["rows"]:
                                respuesta += f"- **{row['compania'].upper()}**: {row['resistencia_promedio']:.1f} MPa\n"
                        else:
                            respuesta = "‚ùå No se pudieron obtener los datos"

                    else:
                        respuesta = """
‚ùì No pude entender tu pregunta.

**Intenta preguntas como:**

- "Cual es la huella promedio de MZMA en 2024?"
- "Cuales son los productos con mayor huella de carbono?"
- "Que compa√±ias tienen datos en la base?"
- "Muestra el top 5 de productos por huella"
- "Cuantos remitos hay en total?"
- "Cual es la resistencia promedio por compa√±ia?"
"""

                    # Mostrar respuesta
                    st.markdown(respuesta)

                    # Mostrar datos si existen
                    if sql_data:
                        with st.expander(f"üìä Datos consultados ({len(sql_data)} registros)"):
                            df = pd.DataFrame(sql_data)
                            st.dataframe(df, use_container_width=True)

                    # Agregar a historial
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": respuesta,
                        "sql_data": sql_data
                    })

                except Exception as e:
                    st.error(f"‚ùå Error: {e}")
                    import traceback
                    st.code(traceback.format_exc())

    # Input de usuario - Campo de texto libre en la parte inferior
    if prompt := st.chat_input("‚úçÔ∏è Pregunta sobre datos de huella de carbono, compa√±√≠as, resistencias..."):
        # Agregar mensaje del usuario
        st.session_state.messages.append({"role": "user", "content": prompt})
        st.rerun()

    # Footer
    st.divider()
    st.caption(f"üí¨ Chat de Benchmarking - Solo consultas SQL a PostgreSQL")


# Run the app
app()
